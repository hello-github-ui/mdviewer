---
id: 09-å•ä¾‹æ¨¡å¼
title: 09-å•ä¾‹æ¨¡å¼
tags: [Python]
---

åœ¨ Python ä¸­ï¼Œ**å•ä¾‹æ¨¡å¼**æ˜¯ä¸€ç§å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ï¼Œç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹ã€‚è¿™åœ¨éœ€è¦å…¨å±€å…±äº«çŠ¶æ€ã€é…ç½®ç®¡ç†ã€èµ„æºç®¡ç†ç­‰åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ã€‚

## æ ¸å¿ƒæ¦‚å¿µ

- **å”¯ä¸€æ€§**ï¼šç±»åœ¨åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä¸­åªä¼šåˆ›å»ºä¸€ä¸ªå®ä¾‹ã€‚
- **å…¨å±€è®¿é—®**ï¼šé€šè¿‡ç±»æä¾›çš„ä¸€ä¸ªè®¿é—®æ–¹æ³•ï¼Œæ‰€æœ‰ä½¿ç”¨è€…éƒ½èƒ½å¾—åˆ°åŒä¸€ä¸ªå®ä¾‹ã€‚
- **å»¶è¿Ÿå®ä¾‹åŒ–ï¼ˆå¯é€‰ï¼‰**ï¼šåœ¨éœ€è¦æ—¶æ‰åˆ›å»ºå®ä¾‹ï¼Œå‡å°‘ä¸å¿…è¦çš„èµ„æºå ç”¨ã€‚

## å•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼

### 1.ä½¿ç”¨ç±»å˜é‡

```python
class Singleton:
    _instance = None

    def __new__(cls, *args, **kwargs):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance


# æµ‹è¯•
a = Singleton()
b = Singleton()
print(a is b) # True
```

**åŸç†ï¼š**

- `_instance` ç±»å˜é‡ä¿å­˜å®ä¾‹ã€‚
- `__new__` æ–¹æ³•æ§åˆ¶å®ä¾‹åˆ›å»ºï¼Œåªæœ‰åœ¨é¦–æ¬¡è°ƒç”¨æ—¶åˆ›å»ºå®ä¾‹ï¼Œè¯¥æ–¹æ³•åœ¨åˆ›å»ºå®ä¾‹æ—¶è‡ªåŠ¨è¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•è¢«è°ƒç”¨åä¼šè‡ªåŠ¨è°ƒç”¨ `__init__` åˆå§‹åŒ–æ–¹æ³•ã€‚

### 2.ä½¿ç”¨è£…é¥°å™¨

```python
def singleton(cls):
    instances = {}  # ä½¿ç”¨å­—å…¸æ¥æ‰¿æ¥ç±»å’Œç±»å®ä¾‹å¯¹è±¡çš„æ˜ å°„å…³ç³»

    def get_instance(*args, **kwargs):
        if cls not in instances:
            instances[cls] = cls(*args, **kwargs)
        return instances[cls]  # è¿”å›è¯¥clsç±»çš„å®ä¾‹å¯¹è±¡

    return get_instance


@singleton
class Singleton:
    pass


a = Singleton()
b = Singleton()
print(a is b)  # True
```

**åŸç†ï¼š**

- `instances` å­—å…¸ä¿å­˜ç±»ä¸å®ä¾‹çš„æ˜ å°„ã€‚
- è£…é¥°å™¨ç¡®ä¿åªåˆ›å»ºä¸€ä¸ªç±»å®ä¾‹ã€‚

### 3.ä½¿ç”¨æ¨¡å—ï¼ˆPythonç‹¬æœ‰ï¼‰

Python çš„æ¨¡å—å¤©ç„¶æ˜¯å•ä¾‹ï¼Œå› ä¸ºæ¨¡å—åœ¨ç¬¬ä¸€æ¬¡å¯¼å…¥æ—¶ä¼šè¢«ç¼“å­˜ã€‚

```python
# singleton_module.py
class Singleton:
    def __init__(self):
        self.value = 42

singleton = Singleton()
```

ä½¿ç”¨æ—¶ï¼š

```python
from singleton_module import singleton
print(singleton.value)  # 42
```

**åŸç†ï¼š**

- æ¨¡å—åªä¼šè¢«å¯¼å…¥å’Œæ‰§è¡Œä¸€æ¬¡ï¼Œå…¶å†…å®¹è¢«ç¼“å­˜ã€‚
- æ— è®ºåœ¨å“ªå¼•å…¥è¯¥æ¨¡å—ï¼Œéƒ½ä¼šå¼•ç”¨åŒä¸€ä¸ªå®ä¾‹ã€‚

### 4.ä½¿ç”¨ `metaclass` å…ƒç±»

```python
class SingletonMeta(type):
    _instances = {}

    def __call__(cls, *args, **kwargs):
        if cls not in cls._instances:
            cls._instances[cls] = super().__call__(*args, **kwargs)
        return cls._instances[cls]


class Singleton(metaclass=SingletonMeta):
    pass


# æµ‹è¯•
a = Singleton()
b = Singleton()
print(a == b) # True
```

**åŸç†ï¼š**

- `metaclass` æ§åˆ¶ç±»çš„å®ä¾‹åŒ–è¿‡ç¨‹ã€‚
- `__call__` æ‹¦æˆªå®ä¾‹åˆ›å»ºé€»è¾‘ï¼Œç¡®ä¿åªåˆ›å»ºä¸€ä¸ªå®ä¾‹ã€‚

**è¡¥å……ï¼š** `hasattr(obj, str)`å‡½æ•°

åœ¨ Python ä¸­ï¼Œ`hasattr()` æ˜¯ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œç”¨äºåˆ¤æ–­å¯¹è±¡æ˜¯å¦æœ‰æŸä¸ªå±æ€§ã€‚å®ƒçš„è¯­æ³•æ˜¯ï¼š

```python
hasattr(object, name)
```

- `object`ï¼šè¦æ£€æŸ¥çš„å¯¹è±¡ã€‚
- `name`ï¼šå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºå±æ€§åã€‚

å¦‚æœå¯¹è±¡ä¸­å­˜åœ¨è¿™ä¸ªå±æ€§ï¼Œ`hasattr()` è¿”å› `True`ï¼Œå¦åˆ™è¿”å› `False`ã€‚

**ä¾‹å­ï¼š**

```python
class Person:
    def __init__(self, name):
        self.name = name

person = Person("Alice")

print(hasattr(person, "name"))      # Trueï¼Œå› ä¸º person å¯¹è±¡æœ‰ name å±æ€§
print(hasattr(person, "age"))       # Falseï¼Œå› ä¸ºæ²¡æœ‰ age å±æ€§
print(hasattr(person, "__init__"))  # Trueï¼Œ__init__ æ˜¯ç±»çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå±æ€§
```

**æ³¨æ„äº‹é¡¹ï¼š**

- `hasattr()` å®é™…ä¸Šä¼šå°è¯•è®¿é—®è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥å¦‚æœå±æ€§çš„è®¿é—®å™¨ä¸­æœ‰å‰¯ä½œç”¨ï¼ˆæ¯”å¦‚æŠ›å‡ºå¼‚å¸¸æˆ–ä¿®æ”¹çŠ¶æ€ï¼‰ï¼Œè°ƒç”¨ `hasattr()` å¯èƒ½ä¼šè§¦å‘è¿™äº›å‰¯ä½œç”¨ã€‚
- å¦‚æœå±æ€§å­˜åœ¨ï¼Œä½†è®¿é—®æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œ`hasattr()` ä¼šè¿”å› `False`ã€‚

**å°æŠ€å·§ï¼š**ä½ å¯ä»¥ç»“åˆ `getattr()` ä½¿ç”¨ï¼Œåœ¨ç¡®è®¤å±æ€§å­˜åœ¨åå†å®‰å…¨åœ°è·å–å…¶å€¼ï¼š

```python
if hasattr(person, "name"):
    name = getattr(person, "name")
    print(name)
```

### 5.ä½¿ç”¨ `threading.Lock` ä¿è¯çº¿ç¨‹å®‰å…¨

åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨é”æ¥ä¿è¯å•ä¾‹å®‰å…¨ã€‚

```python
import threading


class Singleton:
    _instance = None
    _lock = threading.Lock()

    def __new__(cls, *args, **kwargs):
        if cls._instance is None:
            with cls._lock:
                if cls._instance is None:  # åŒé‡æ£€æŸ¥
                    cls._instance = super().__new__(cls, *args, **kwargs)
        return cls._instance


# æµ‹è¯•
a = Singleton()
b = Singleton()
print(id(a)) # 1734385437776
print(id(b)) # 1734385437776
```

**åŸç†ï¼š**

- `threading.Lock()` æ§åˆ¶å¯¹ç±»å®ä¾‹çš„è®¿é—®ã€‚
- åŒé‡æ£€æŸ¥ç¡®ä¿æŒ‡åœ¨éœ€è¦æ—¶åŠ é”ï¼Œæä¾›æ€§èƒ½ã€‚

### 6.ä½¿ç”¨ `@classmethod`

```python
class Singleton:
    _instance = None

    @classmethod
    def get_instance(cls):
        if cls._instance is None:
            cls._instance = cls()
        return cls._instance

# æµ‹è¯•
a = Singleton.get_instance()
b = Singleton.get_instance()
print(a is b)  # True
```

**åŸç†**ï¼š

- `get_instance` æ˜¯ä¸€ä¸ªç±»æ–¹æ³•ï¼Œç”¨äºç®¡ç†ç±»çš„å”¯ä¸€å®ä¾‹ã€‚
- `_instance` ç±»å˜é‡ä¿å­˜å”¯ä¸€å®ä¾‹ï¼Œç¡®ä¿åªåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶åˆ›å»ºã€‚

**ä¼˜ç¼ºç‚¹**ï¼š

- **ä¼˜ç‚¹**ï¼šå®ç°ç®€å•ï¼Œé€»è¾‘æ¸…æ™°ã€‚
- **ç¼ºç‚¹**ï¼šå®ä¾‹è·å–æ–¹å¼ç¨æ˜¾ç¹çï¼Œéœ€è¦é€šè¿‡ç±»æ–¹æ³•è°ƒç”¨ã€‚
- **çº¿ç¨‹å®‰å…¨**ï¼šä¸å®‰å…¨ï¼Œéœ€è¦åŠ é”å¤„ç†å¤šçº¿ç¨‹åœºæ™¯ã€‚

### 7.ä½¿ç”¨ `__new__`ï¼ˆåŸºç¡€å®ç°ï¼‰

è¿™ç§æ–¹å¼å…¶å®å’Œæˆ‘ä»¬å‰é¢æåˆ°çš„ç±»å˜é‡å®ç°ç±»ä¼¼ï¼Œä½†æ›´ç›´æ¥ã€‚

```python
class Singleton:
    _instance = None

    def __new__(cls, *args, **kwargs):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance

    def __init__(self):
        # è¿™é‡Œçš„ __init__ åªä¼šåœ¨é¦–æ¬¡å®ä¾‹åŒ–æ—¶è°ƒç”¨
        self.value = 42

# æµ‹è¯•
a = Singleton()
b = Singleton()
print(a is b)  # True
print(a.value)  # 42
b.value = 99
print(a.value)  # 99 ï¼ˆè¯´æ˜æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼‰
```

**åŸç†**ï¼š

- `__new__` æ˜¯ Python ä¸­ç”¨äºæ§åˆ¶å®ä¾‹åˆ›å»ºçš„ç‰¹æ®Šæ–¹æ³•ï¼Œå®ƒåœ¨ `__init__` æ‰§è¡Œå‰æ‰§è¡Œã€‚
- é€šè¿‡ç±»å˜é‡ `_instance` æ§åˆ¶åªåˆ›å»ºä¸€ä¸ªå®ä¾‹ã€‚

**ä¼˜ç¼ºç‚¹**ï¼š

- **ä¼˜ç‚¹**ï¼šç®€å•ç›´æ¥ï¼Œå…¼å®¹æ™®é€šç±»çš„åˆå§‹åŒ–æ–¹å¼ã€‚
- **ç¼ºç‚¹**ï¼šæ²¡æœ‰çº¿ç¨‹å®‰å…¨ï¼Œéœ€è¦åœ¨å¤šçº¿ç¨‹ä¸­åŠ é”ã€‚

### æ‰©å±•ï¼šåŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨ï¼ˆç»“åˆ `__new__`ï¼‰

å¦‚æœéœ€è¦åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ç¡®ä¿å•ä¾‹å®‰å…¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `__new__` ä¸­åŠ é”å®ç°åŒé‡æ£€æŸ¥ã€‚

```python
import threading

class Singleton:
    _instance = None
    _lock = threading.Lock()

    def __new__(cls, *args, **kwargs):
        if cls._instance is None:
            with cls._lock:  # åŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨
                if cls._instance is None:  # åŒé‡æ£€æŸ¥
                    cls._instance = super(Singleton, cls).__new__(cls)
        return cls._instance

# æµ‹è¯•
a = Singleton()
b = Singleton()
print(a is b)  # True
```

**æ€»ç»“è¿™ä¸¤ç§æ–¹æ³•ï¼š**

| å®ç°æ–¹å¼          | ç®€æ´æ€§ | çµæ´»æ€§ | çº¿ç¨‹å®‰å…¨ | ä½¿ç”¨åœºæ™¯               |
| ----------------- | ------ | ------ | -------- | ---------------------- |
| `@classmethod`    | ä¸­ç­‰   | è¾ƒçµæ´» | å¦       | æ˜ç¡®é€šè¿‡ç±»æ–¹æ³•è·å–å®ä¾‹ |
| `__new__`ï¼ˆåŸºç¡€ï¼‰ | ç®€å•   | é«˜     | å¦       | å¸¸è§„ç±»åˆå§‹åŒ–åœºæ™¯       |
| `__new__`ï¼ˆåŠ é”ï¼‰ | ä¸­ç­‰   | é«˜     | æ˜¯       | å¤šçº¿ç¨‹ç¯å¢ƒ             |

è¿™ä¸¤ç§æ–¹æ³•ç¡®å®ä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„å®ç°æ–¹å¼ï¼Œå°¤å…¶æ˜¯ `__new__`ï¼Œå¯ä»¥è¯´æ˜¯ Python ä¸­å®ç°å•ä¾‹æ¨¡å¼çš„ç»å…¸æ–¹æ³•ã€‚

å¦‚æœä½ æ›´å–œæ¬¢é€šè¿‡ç±»æ–¹æ³•æ˜¾å¼ç®¡ç†å®ä¾‹ï¼Œç”¨ `@classmethod`ï¼›
å¦‚æœä½ å¸Œæœ›æ›´åƒæ™®é€šç±»çš„ç”¨æ³•ï¼Œä½†ä»ä¿æŒå•ä¾‹ç‰¹æ€§ï¼Œç”¨ `__new__`ã€‚

ä½ è§‰å¾—å“ªç§æ–¹å¼æ›´é€‚åˆä½ çš„éœ€æ±‚ï¼Ÿæˆ–è€…éœ€è¦å¸®ä½ å®Œå–„æŸä¸ªå®ç°å—ï¼Ÿ ğŸ˜„

## æ€»ç»“

| å®ç°æ–¹å¼         | ç®€æ´æ€§ | çµæ´»æ€§ | çº¿ç¨‹å®‰å…¨ | Pythonç‰¹æ€§ |
| ---------------- | ------ | ------ | -------- | ---------- |
| ç±»å˜é‡           | ç®€å•   | é«˜     | å¦       | å¦         |
| è£…é¥°å™¨           | ç®€æ´   | ä¸­ç­‰   | å¦       | å¦         |
| æ¨¡å—             | æœ€ç®€   | ä½     | æ˜¯       | æ˜¯         |
| å…ƒç±» `metaclass` | ç¨å¤æ‚ | é«˜     | å¦       | æ˜¯         |
| å¸¦é”çš„ç±»å˜é‡     | ä¸­ç­‰   | é«˜     | æ˜¯       | å¦         |

å¦‚æœä½ è¿½æ±‚ç®€å•æ€§ï¼Œç›´æ¥ç”¨**æ¨¡å—**æˆ–**ç±»å˜é‡**å®ç°ï¼›
å¦‚æœéœ€è¦å¼ºçµæ´»æ€§ï¼Œ**`metaclass`** å®ç°éå¸¸åˆé€‚ï¼›
å¦‚æœæ˜¯å¤šçº¿ç¨‹åœºæ™¯ï¼Œå»ºè®®ç”¨**å¸¦é”å®ç°**ã€‚

éœ€è¦æˆ‘å¸®ä½ åˆ†æå“ªç§å®ç°æ›´é€‚åˆä½ çš„é¡¹ç›®å—ï¼Ÿ ğŸ˜Š